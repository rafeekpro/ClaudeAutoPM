#!/usr/bin/env node

/**
 * PM Workflow Simulation - Issues, Tasks, Epics
 *
 * Shows how token optimization works with full PM workflow:
 * - Issue creation
 * - Epic decomposition
 * - Task management
 * - Implementation
 * - PR creation
 * - Task completion
 */

const fs = require('fs');
const path = require('path');
const readline = require('readline');

const CHARS_PER_TOKEN = 4;

function estimateTokens(text) {
  const normalized = text.replace(/\s+/g, ' ').trim();
  return Math.ceil(normalized.length / CHARS_PER_TOKEN);
}

function loadFile(filePath) {
  if (!fs.existsSync(filePath)) {
    return { content: '', tokens: 0, exists: false };
  }
  const content = fs.readFileSync(filePath, 'utf-8');
  return {
    content,
    tokens: estimateTokens(content),
    exists: true
  };
}

class PMWorkflowSimulator {
  constructor() {
    this.totalTokens = 0;
    this.loadedFiles = [];
    this.step = 0;
  }

  displayHeader() {
    console.log('\n' + '='.repeat(80));
    console.log('üé¨ PM WORKFLOW SIMULATION: Complete Issue ‚Üí Task ‚Üí Implementation Cycle');
    console.log('='.repeat(80));
    console.log('\nScenario: User wants to add "User Profile Management" feature');
    console.log('We\'ll follow complete workflow from Issue creation to completion.');
    console.log('\nPress ENTER to proceed through each step...\n');
  }

  async waitForEnter() {
    const rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout
    });

    return new Promise(resolve => {
      rl.question('', () => {
        rl.close();
        resolve();
      });
    });
  }

  displayStep(title, description) {
    this.step++;
    console.log('\n' + '‚îÄ'.repeat(80));
    console.log(`\nüìç STEP ${this.step}: ${title}`);
    console.log(`   ${description}`);
    console.log('');
  }

  loadAndDisplay(filePath, name, reason) {
    const file = loadFile(filePath);

    if (!file.exists) {
      console.log(`   ‚ö†Ô∏è  File not found: ${filePath}`);
      return 0;
    }

    this.totalTokens += file.tokens;
    this.loadedFiles.push({ name, tokens: file.tokens, path: filePath });

    console.log(`   üìÇ Loading: ${name}`);
    console.log(`   üìÑ File: ${path.basename(filePath)}`);
    console.log(`   üíæ Tokens: ${file.tokens.toLocaleString()}`);
    console.log(`   üìù Why: ${reason}`);
    console.log(`   üìä Running Total: ${this.totalTokens.toLocaleString()} tokens`);

    return file.tokens;
  }

  displayCommand(command, description) {
    console.log(`\n   üí¨ User Command: ${command}`);
    console.log(`   üìù Description: ${description}`);
  }

  displayContext() {
    console.log('\n   üí° CURRENT CONTEXT STATE:');
    console.log('   ‚îå' + '‚îÄ'.repeat(76) + '‚îê');
    this.loadedFiles.forEach((file, idx) => {
      const info = `${idx + 1}. ${file.name} (${file.tokens} tokens)`;
      console.log(`   ‚îÇ ${info.padEnd(74)} ‚îÇ`);
    });
    console.log('   ‚îú' + '‚îÄ'.repeat(76) + '‚î§');
    console.log(`   ‚îÇ ${'TOTAL TOKENS IN CONTEXT:'.padEnd(50)} ${this.totalTokens.toString().padStart(24)} ‚îÇ`);
    console.log('   ‚îî' + '‚îÄ'.repeat(76) + '‚îò');
  }

  displayComparison(oldSystemTokens) {
    const savings = oldSystemTokens - this.totalTokens;
    const percent = ((savings / oldSystemTokens) * 100).toFixed(1);

    console.log('\n   üìä vs OLD SYSTEM:');
    console.log(`      Old: ${oldSystemTokens.toLocaleString()} tokens`);
    console.log(`      New: ${this.totalTokens.toLocaleString()} tokens`);
    console.log(`      üí∞ Savings: ${savings.toLocaleString()} tokens (${percent}% reduction)`);
  }

  displayOutput(content) {
    console.log('\n   üì§ Output:');
    console.log('   ‚îå' + '‚îÄ'.repeat(76) + '‚îê');
    content.split('\n').forEach(line => {
      const truncated = line.substring(0, 74);
      console.log(`   ‚îÇ ${truncated.padEnd(74)} ‚îÇ`);
    });
    console.log('   ‚îî' + '‚îÄ'.repeat(76) + '‚îò');
  }
}

async function runSimulation() {
  const sim = new PMWorkflowSimulator();
  const baseDir = path.join(__dirname, '..');

  sim.displayHeader();
  await sim.waitForEnter();

  // ============================================================================
  // PHASE 1: ISSUE CREATION
  // ============================================================================

  sim.displayStep(
    'SESSION START',
    'User starts new session to create an issue'
  );

  sim.loadAndDisplay(
    path.join(baseDir, 'autopm/.claude/templates/claude-templates/base-optimized.md'),
    'Optimized Base Template',
    'Initial session startup - minimal context'
  );

  console.log('\n   ‚ú® Loaded context includes:');
  console.log('      ‚Ä¢ Core priorities (TDD, Agents, Context7)');
  console.log('      ‚Ä¢ Lazy loading triggers');
  console.log('      ‚Ä¢ Compressed agent/command lists');

  sim.displayContext();
  sim.displayComparison(45199);
  await sim.waitForEnter();

  // ============================================================================

  sim.displayStep(
    'CREATE ISSUE',
    'User wants to create GitHub issue for User Profile feature'
  );

  sim.displayCommand(
    '/pm:issue-create',
    'Create new GitHub issue with proper template and labels'
  );

  console.log('\n   üîç System detects:');
  console.log('      ‚Ä¢ Command: /pm:issue-create');
  console.log('      ‚Ä¢ Needs to load command file');
  console.log('      ‚Ä¢ Needs PM workflow context');

  await sim.waitForEnter();

  sim.loadAndDisplay(
    path.join(baseDir, 'autopm/.claude/commands/pm/issue-create.md'),
    'Issue Creation Command',
    'Command file with template and Context7 queries'
  );

  console.log('\n   üìã Command file contains:');
  console.log('      ‚Ä¢ Issue template structure');
  console.log('      ‚Ä¢ Required fields (title, description, labels)');
  console.log('      ‚Ä¢ Documentation Queries for best practices');

  sim.displayContext();
  sim.displayComparison(45199);
  await sim.waitForEnter();

  // ============================================================================

  sim.displayStep(
    'CONTEXT7 QUERY - Issue Best Practices',
    'Querying Context7 for GitHub issue best practices'
  );

  console.log('   üåê Queries executed:');
  console.log('      ‚Ä¢ mcp://context7/github/issues');
  console.log('      ‚Ä¢ mcp://context7/agile/user-stories');
  console.log('      ‚Ä¢ mcp://context7/project-management/requirements');

  const context7Tokens = 200;
  sim.totalTokens += context7Tokens;
  sim.loadedFiles.push({
    name: 'Context7: GitHub Issues',
    tokens: context7Tokens,
    path: 'mcp://context7/...'
  });

  console.log(`\n   üìä Context7 results: ${context7Tokens} tokens`);
  console.log('   ‚úÖ Learned current best practices for issue creation');

  sim.displayContext();
  sim.displayComparison(45199);
  await sim.waitForEnter();

  // ============================================================================

  sim.displayStep(
    'ISSUE CREATED',
    'GitHub issue created with proper structure'
  );

  sim.displayOutput(`Issue #123: Add User Profile Management

**Description:**
As a user, I want to manage my profile information so that I can
keep my account details up to date.

**Acceptance Criteria:**
- [ ] User can view their profile
- [ ] User can edit name, email, avatar
- [ ] Changes are persisted to database
- [ ] Profile changes are validated

**Labels:** enhancement, backend, frontend
**Epic:** User Management`);

  console.log('\n   ‚úÖ Issue created in GitHub');
  console.log('   üîÑ Ready for epic decomposition');

  await sim.waitForEnter();

  // ============================================================================
  // PHASE 2: EPIC DECOMPOSITION
  // ============================================================================

  sim.displayStep(
    'EPIC DECOMPOSITION',
    'User wants to decompose issue into tasks'
  );

  sim.displayCommand(
    '/pm:epic-decompose "User Profile Management"',
    'Break down issue into implementable tasks'
  );

  console.log('\n   üîç System detects:');
  console.log('      ‚Ä¢ Command: /pm:epic-decompose');
  console.log('      ‚Ä¢ Needs epic decomposition logic');
  console.log('      ‚Ä¢ Needs task breakdown best practices');

  await sim.waitForEnter();

  sim.loadAndDisplay(
    path.join(baseDir, 'autopm/.claude/commands/pm/epic-decompose.md'),
    'Epic Decomposition Command',
    'Command with decomposition patterns and Context7 queries'
  );

  sim.displayContext();
  sim.displayComparison(45199);
  await sim.waitForEnter();

  // ============================================================================

  sim.displayStep(
    'CONTEXT7 QUERY - Epic Decomposition',
    'Querying Context7 for task breakdown best practices'
  );

  console.log('   üåê Queries executed:');
  console.log('      ‚Ä¢ mcp://context7/agile/epic-decomposition');
  console.log('      ‚Ä¢ mcp://context7/agile/task-sizing');
  console.log('      ‚Ä¢ mcp://context7/agile/user-stories');

  const context7Tokens2 = 200;
  sim.totalTokens += context7Tokens2;
  sim.loadedFiles.push({
    name: 'Context7: Epic Decomposition',
    tokens: context7Tokens2,
    path: 'mcp://context7/...'
  });

  console.log(`\n   üìä Context7 results: ${context7Tokens2} tokens`);
  console.log('   ‚úÖ Learned INVEST criteria and task sizing');

  sim.displayContext();
  sim.displayComparison(45199);
  await sim.waitForEnter();

  // ============================================================================

  sim.displayStep(
    'TASKS CREATED',
    'Epic decomposed into implementable tasks'
  );

  sim.displayOutput(`Created 5 tasks for Issue #123:

Task 1: Create User model with profile fields
  - Status: ready
  - Size: S
  - Type: backend

Task 2: Build profile view API endpoint
  - Status: ready
  - Size: S
  - Type: backend

Task 3: Build profile update API endpoint
  - Status: ready
  - Size: M
  - Type: backend

Task 4: Create profile view UI component
  - Status: ready
  - Size: M
  - Type: frontend

Task 5: Create profile edit UI component
  - Status: ready
  - Size: M
  - Type: frontend`);

  console.log('\n   ‚úÖ Tasks created in backlog');
  console.log('   üîÑ Ready to pick first task');

  await sim.waitForEnter();

  // ============================================================================
  // PHASE 3: TASK IMPLEMENTATION
  // ============================================================================

  sim.displayStep(
    'PICK TASK',
    'User selects first task to implement'
  );

  sim.displayCommand(
    '/pm:task-start "Create User model with profile fields"',
    'Start working on Task 1'
  );

  console.log('\n   üìã Task Details:');
  console.log('      ‚Ä¢ Type: Backend implementation');
  console.log('      ‚Ä¢ Requires: Python, SQLAlchemy, database migration');
  console.log('      ‚Ä¢ Must follow: TDD cycle');

  await sim.waitForEnter();

  // Load workflow steps
  sim.loadAndDisplay(
    path.join(baseDir, 'autopm/.claude/quick-ref/workflow-steps.md'),
    'Workflow Quick Reference',
    'Standard task workflow - triggered by task-start command'
  );

  sim.displayContext();
  sim.displayComparison(45199);
  await sim.waitForEnter();

  // ============================================================================

  sim.displayStep(
    'TDD ENFORCEMENT',
    'System enforces TDD cycle for implementation'
  );

  console.log('   üîç Workflow requires TDD');
  console.log('   üîÑ Loading TDD quick reference...');

  await sim.waitForEnter();

  sim.loadAndDisplay(
    path.join(baseDir, 'autopm/.claude/quick-ref/tdd-cycle.md'),
    'TDD Quick Reference',
    'RED-GREEN-REFACTOR cycle - required for all implementations'
  );

  sim.displayContext();
  sim.displayComparison(45199);
  await sim.waitForEnter();

  // ============================================================================

  sim.displayStep(
    'AGENT SELECTION',
    'Claude selects specialized agent for implementation'
  );

  console.log('   ü§î Decision process:');
  console.log('      ‚Ä¢ Task type: Backend Python');
  console.log('      ‚Ä¢ Technology: SQLAlchemy models');
  console.log('      ‚Ä¢ Required agent: @python-backend-engineer');

  await sim.waitForEnter();

  sim.loadAndDisplay(
    path.join(baseDir, 'autopm/.claude/agents/languages/python-backend-engineer.md'),
    'Python Backend Engineer Agent',
    'Specialist agent for Python/SQLAlchemy implementation'
  );

  sim.displayContext();
  sim.displayComparison(45199);
  await sim.waitForEnter();

  // ============================================================================

  sim.displayStep(
    'CONTEXT7 QUERY - Implementation',
    'Agent queries Context7 for current SQLAlchemy patterns'
  );

  console.log('   üåê Queries executed:');
  console.log('      ‚Ä¢ mcp://context7/sqlalchemy/models');
  console.log('      ‚Ä¢ mcp://context7/sqlalchemy/migrations');
  console.log('      ‚Ä¢ mcp://context7/pydantic/validation');

  const context7Tokens3 = 200;
  sim.totalTokens += context7Tokens3;
  sim.loadedFiles.push({
    name: 'Context7: SQLAlchemy Patterns',
    tokens: context7Tokens3,
    path: 'mcp://context7/...'
  });

  console.log(`\n   üìä Context7 results: ${context7Tokens3} tokens`);
  console.log('   ‚úÖ Learned current SQLAlchemy 2.0 patterns');

  sim.displayContext();
  sim.displayComparison(45199);
  await sim.waitForEnter();

  // ============================================================================

  sim.displayStep(
    'IMPLEMENTATION - TDD CYCLE',
    'Agent implements following RED-GREEN-REFACTOR'
  );

  sim.displayOutput(`üî¥ RED PHASE:
Created: tests/test_user_model.py
Test: test_user_model_has_profile_fields()
Status: ‚ùå FAILS (model doesn't exist yet)
Commit: test: add failing test for User profile fields

‚úÖ GREEN PHASE:
Created: app/models/user.py
Implementation: User model with name, email, avatar
Status: ‚úÖ PASSES
Commit: feat: add User model with profile fields

‚ôªÔ∏è  REFACTOR PHASE:
Improvements: Add validators, improve type hints
Status: ‚úÖ PASSES (all tests still green)
Commit: refactor: improve User model structure`);

  console.log('\n   ‚úÖ Task implementation complete');
  console.log('   üîÑ Ready to create PR');

  await sim.waitForEnter();

  // ============================================================================
  // PHASE 4: PR CREATION
  // ============================================================================

  sim.displayStep(
    'CREATE PULL REQUEST',
    'User creates PR for completed task'
  );

  sim.displayCommand(
    '/pm:pr-create',
    'Create PR with task details and test evidence'
  );

  console.log('\n   üìã PR includes:');
  console.log('      ‚Ä¢ Link to task');
  console.log('      ‚Ä¢ Implementation summary');
  console.log('      ‚Ä¢ Test results');
  console.log('      ‚Ä¢ Acceptance criteria verification');

  await sim.waitForEnter();

  sim.displayOutput(`Pull Request #456: Add User model with profile fields

**Related Task:** Task 1 of Issue #123

**Changes:**
- Created User model with profile fields (name, email, avatar)
- Added SQLAlchemy migration
- Added comprehensive tests
- Added field validation

**Test Results:**
‚úÖ test_user_model_has_profile_fields
‚úÖ test_user_model_validates_email
‚úÖ test_user_model_handles_avatar_upload
All tests passing (3/3)

**TDD Evidence:**
Git history shows proper cycle:
- test: add failing test for User profile fields
- feat: add User model with profile fields
- refactor: improve User model structure

**Acceptance Criteria:**
‚úÖ User model created with required fields
‚úÖ Database migration generated
‚úÖ Tests written and passing
‚úÖ Field validation implemented`);

  console.log('\n   ‚úÖ PR created in GitHub');

  await sim.waitForEnter();

  // ============================================================================
  // PHASE 5: TASK COMPLETION
  // ============================================================================

  sim.displayStep(
    'COMPLETE TASK',
    'After PR merged, mark task as completed'
  );

  sim.displayCommand(
    '/pm:task-complete "Create User model with profile fields"',
    'Mark task as completed and update issue'
  );

  sim.displayOutput(`Task 1: Create User model with profile fields
Status: ready ‚Üí in_progress ‚Üí completed ‚úÖ

Issue #123 updated:
Progress: 1/5 tasks complete (20%)

Next task ready:
Task 2: Build profile view API endpoint`);

  console.log('\n   ‚úÖ Task marked as completed');
  console.log('   üîÑ Ready for next task');

  await sim.waitForEnter();

  // ============================================================================
  // FINAL SUMMARY
  // ============================================================================

  console.log('\n\n' + '='.repeat(80));
  console.log('üéØ PM WORKFLOW SIMULATION - COMPLETE');
  console.log('='.repeat(80));

  console.log('\nüìö Complete Workflow Covered:');
  console.log('  1. ‚úÖ Issue Creation (/pm:issue-create)');
  console.log('  2. ‚úÖ Epic Decomposition (/pm:epic-decompose)');
  console.log('  3. ‚úÖ Task Start (/pm:task-start)');
  console.log('  4. ‚úÖ TDD Implementation (RED-GREEN-REFACTOR)');
  console.log('  5. ‚úÖ PR Creation (/pm:pr-create)');
  console.log('  6. ‚úÖ Task Completion (/pm:task-complete)');

  console.log('\nüìä Token Usage Throughout Workflow:');
  console.log('  Files loaded: ' + sim.loadedFiles.length);
  console.log('  Total tokens: ' + sim.totalTokens.toLocaleString());
  console.log('  Old system: 45,199 tokens');
  console.log('  Savings: ' + (45199 - sim.totalTokens).toLocaleString() + ' tokens');
  console.log('  Reduction: ' + (((45199 - sim.totalTokens) / 45199) * 100).toFixed(1) + '%');

  console.log('\nüí° Key Insights:');
  console.log('  ‚Ä¢ Loaded ONLY files needed for specific PM commands');
  console.log('  ‚Ä¢ Context7 queried for best practices at each phase');
  console.log('  ‚Ä¢ TDD enforced through lazy-loaded quick reference');
  console.log('  ‚Ä¢ Workflow guidance loaded on-demand');
  console.log('  ‚Ä¢ Specialized agents used for implementation');
  console.log('  ‚Ä¢ Total context stays under 5,000 tokens');
  console.log('  ‚Ä¢ 90%+ savings vs old system throughout workflow');

  console.log('\nüîë Lazy Loading in Action:');
  sim.loadedFiles.forEach((file, idx) => {
    console.log(`  ${idx + 1}. ${file.name} (${file.tokens} tokens)`);
    console.log(`     Loaded: ${file.path}`);
  });

  console.log('\n‚úÖ Workflow completed with minimal token usage!');
  console.log('='.repeat(80));
}

runSimulation().catch(console.error);
